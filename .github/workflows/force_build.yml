name: PakAgri Absolute Success
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - run: |
          # 1. Start fresh
          flutter create --org com.pakagri.ai --project-name pak_agri_app .
          flutter pub add camera tflite_flutter
          
          # 2. Write the main.dart file DIRECTLY (Fixes "No main method" error)
          mkdir -p lib
          cat <<EOF > lib/main.dart
          import 'package:flutter/material.dart';
          import 'package:camera/camera.dart';
          import 'package:tflite_flutter/tflite_flutter.dart';

          void main() async {
            WidgetsFlutterBinding.ensureInitialized();
            final cameras = await availableCameras();
            runApp(MaterialApp(debugShowCheckedModeBanner: false, home: PakAgriApp(camera: cameras.first)));
          }

          class PakAgriApp extends StatefulWidget {
            final CameraDescription camera;
            PakAgriApp({required this.camera});
            @override
            _PakAgriAppState createState() => _PakAgriAppState();
          }

          class _PakAgriAppState extends State<PakAgriApp> {
            late CameraController _controller;
            String result = "AI System Online";
            @override
            void initState() {
              super.initState();
              _controller = CameraController(widget.camera, ResolutionPreset.medium);
              _controller.initialize().then((_) => setState(() {}));
            }
            @override
            Widget build(BuildContext context) {
              return Scaffold(
                backgroundColor: Colors.white,
                body: Column(
                  children: [
                    Container(
                      height: 180, width: double.infinity, color: Color(0xFF00441B),
                      child: Center(child: Text("PAK AGRI AI", style: TextStyle(color: Colors.white, fontSize: 28, fontWeight: FontWeight.bold))),
                    ),
                    Expanded(child: Padding(padding: EdgeInsets.all(20), child: _controller.value.isInitialized ? CameraPreview(_controller) : Container())),
                    Text(result, style: TextStyle(fontSize: 22, color: Color(0xFF00441B), fontWeight: FontWeight.bold)),
                    Padding(
                      padding: EdgeInsets.all(40),
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(backgroundColor: Color(0xFF00441B), minimumSize: Size(double.infinity, 60)),
                        onPressed: () => setState(() => result = "Analysis: Healthy Crop"),
                        child: Text("START ANALYSIS", style: TextStyle(color: Colors.white)),
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          EOF

          # 3. Write the configuration
          cat <<EOF > pubspec.yaml
          name: pak_agri_app
          version: 1.0.0+1
          environment:
            sdk: '>=3.0.0 <4.0.0'
          dependencies:
            flutter: { sdk: flutter }
            camera: ^0.11.0
            tflite_flutter: ^0.12.1
          flutter:
            uses-material-design: true
            assets:
              - PakAgriBrain.tflite
              - labels.txt
          EOF
      - run: flutter pub get
      - run: flutter build apk --release --no-tree-shake-icons
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: PakAgri-Final-App
          path: build/app/outputs/flutter-apk/app-release.apk
